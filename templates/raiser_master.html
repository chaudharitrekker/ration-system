{% extends "base.html" %}
{% block title %}Master List{% endblock %}
{% block content %}
<h1 class="mb-4">üìã Master List - Approved Ration Requests</h1>

<!-- üîé Search Form -->
<form method="GET" class="mb-3 d-flex">
    <input type="text" name="search" class="form-control me-2"
           placeholder="Search by P.No, Name, Rank, Unit"
           value="{{ search }}">
    <button type="submit" class="btn btn-primary">Search</button>
</form>

{% if demands %}

<!-- üîò Tabs -->
<ul class="nav nav-tabs mb-3" id="masterTabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#first15">1st 15 Days</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#second15">2nd 15 Days</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dry">Dry Issue</button>
  </li>
</ul>

<div class="tab-content">
  <!-- 1st 15 Days -->
  <div class="tab-pane fade show active" id="first15">
    <form method="POST" action="{{ url_for('raise_demand') }}" class="raise-form">
      <input type="hidden" name="demand_type" value="first15">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Select</th>
            <th>P.No</th>
            <th>Name</th>
            <th>Rank</th>
            <th>Unit</th>
            <th>Ration Type</th>
            <th>Availability Days (1‚Äì15)</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for d in demands %}
          <tr data-id="{{ d.id }}">
            <td><input type="checkbox" name="selected_ids" value="{{ d.id }}"></td>
            <td>{{ d.employee_number }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.rank }}</td>
            <td>{{ d.unit }}</td>
            <td>{{ d.ration_type }}</td>
            <td><input type="number" name="days_{{ d.id }}" class="form-control first15" min="0" max="15"></td>
            <td>
              <form method="POST" action="{{ url_for('raiser_delete_demand', demand_id=d.id) }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn btn-success">Raise Demand</button>
    </form>
  </div>

  <!-- 2nd 15 Days -->
  <div class="tab-pane fade" id="second15">
    <form method="POST" action="{{ url_for('raise_demand') }}" class="raise-form">
      <input type="hidden" name="demand_type" value="second15">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Select</th>
            <th>P.No</th>
            <th>Name</th>
            <th>Rank</th>
            <th>Unit</th>
            <th>Ration Type</th>
            <th>Availability Days (16‚Äì30)</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for d in demands %}
          <tr data-id="{{ d.id }}">
            <td><input type="checkbox" name="selected_ids" value="{{ d.id }}"></td>
            <td>{{ d.employee_number }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.rank }}</td>
            <td>{{ d.unit }}</td>
            <td>{{ d.ration_type }}</td>
            <td><input type="number" name="days_{{ d.id }}" class="form-control second15" min="0" max="16"></td>
            <td>
              <form method="POST" action="{{ url_for('raiser_delete_demand', demand_id=d.id) }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn btn-success">Raise Demand</button>
    </form>
  </div>

  <!-- Dry Issue -->
  <div class="tab-pane fade" id="dry">
    <form method="POST" action="{{ url_for('raise_demand') }}" class="raise-form">
      <input type="hidden" name="demand_type" value="dry">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Select</th>
            <th>P.No</th>
            <th>Name</th>
            <th>Rank</th>
            <th>Unit</th>
            <th>Ration Type</th>
            <th>Total Days</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for d in dry_list %}
          <tr data-id="{{ d.id }}">
            <td><input type="checkbox" name="selected_ids" value="{{ d.id }}"></td>
            <td>{{ d.employee_number }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.rank }}</td>
            <td>{{ d.unit }}</td>
            <td>{{ d.ration_type }}</td>
            <td><input type="number" name="days_{{ d.id }}" class="form-control dry" min="0" max="31" value="{{ d.dry_days }}"></td>
            <td>
              <form method="POST" action="{{ url_for('raiser_delete_demand', demand_id=d.id) }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn btn-success">Raise Demand</button>
    </form>
  </div>
</div>
{% endif %}

<!-- üî• JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  function updateDryTotals() {
    document.querySelectorAll("tr[data-id]").forEach(function(row) {
      let id = row.getAttribute("data-id");
      let first = document.querySelector(`#first15 input[name="days_${id}"]`);
      let second = document.querySelector(`#second15 input[name="days_${id}"]`);
      let dry = document.querySelector(`#dry input[name="days_${id}"]`);
      if (dry) {
        let total = 0;
        if (first && first.value) total += parseInt(first.value) || 0;
        if (second && second.value) total += parseInt(second.value) || 0;
        dry.value = total;
      }
    });
  }

  // auto-update on input
  document.querySelectorAll(".first15, .second15").forEach(inp => {
    inp.addEventListener("input", updateDryTotals);
  });

  // Remove selected rows after submit
  document.querySelectorAll(".raise-form").forEach(form => {
    form.addEventListener("submit", function(e) {
      e.preventDefault(); // stop normal submit
      let formData = new FormData(form);
      fetch(form.action, {method:"POST", body:formData})
        .then(r => r.text())
        .then(() => {
          form.querySelectorAll("input[name='selected_ids']:checked").forEach(cb => {
            let row = cb.closest("tr");
            if (row) row.remove();
          });
          alert("‚úÖ Demand raised successfully!");
        })
        .catch(err => alert("‚ùå Error: " + err));
    });
  });
});
</script>

{% endblock %}